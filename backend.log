INFO:     Will watch for changes in these directories: ['/Users/dennisgorter/Projects/agentic-orchestrator']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [8480] using StatReload
/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
  warnings.warn(
INFO:     Started server process [8482]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
2026-01-03 19:37:29 | 9ece72ba-5b97-4964-8fb0-04ca6b16cd4e | INFO     | app.main | Incoming request: POST /chat
2026-01-03 19:37:29 | 9ece72ba-5b97-4964-8fb0-04ca6b16cd4e | INFO     | app.main | Chat request - session: user_1767465445326, message: Is my car AB-123-CD allowed to enter Amsterdam cit...
INFO:     127.0.0.1:56020 - "POST /chat HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 189, in __call__
  |     response_sent.set()
  |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | exceptiongroup.ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/protocols/http/h11_impl.py", line 406, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    |     return await self.app(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     response_sent.set()
    |   File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py", line 135, in __exit__
    |     self.gen.throw(type, value, traceback)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 39, in trace_id_middleware
    |     response = await call_next(request)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 163, in call_next
    |     raise app_exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 93, in __call__
    |     await self.simple_response(scope, receive, send, request_headers=headers)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    |     await self.app(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 65, in chat
    |     trace_store = get_trace_store()
    | NameError: name 'get_trace_store' is not defined
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/protocols/http/h11_impl.py", line 406, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 189, in __call__
    response_sent.set()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py", line 135, in __exit__
    self.gen.throw(type, value, traceback)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 39, in trace_id_middleware
    response = await call_next(request)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 93, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    await self.app(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 65, in chat
    trace_store = get_trace_store()
NameError: name 'get_trace_store' is not defined
WARNING:  StatReload detected changes in 'app/main.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [8482]
/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
  warnings.warn(
INFO:     Started server process [9437]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
2026-01-03 19:38:34 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.main | Incoming request: POST /chat
2026-01-03 19:38:34 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.main | Chat request - session: user_1767465512690, message: Is my car AB-123-CD allowed to enter Amsterdam cit...
2026-01-03 19:38:34 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.trace_store | Created trace: 6b6803f5-4498-4b91-a04c-58a9abcc402f
2026-01-03 19:38:34 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.state | [user_1767465512690] Creating NEW SESSION
2026-01-03 19:38:34 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.main | [user_1767465512690] BEFORE GRAPH - car_identifier: None, selected_car: None
2026-01-03 19:38:34 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.main | Starting graph execution - session: user_1767465512690
2026-01-03 19:38:34 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.graph | [user_1767465512690] extract_intent_node - message: Is my car AB-123-CD allowed to enter Amsterdam cit...
2026-01-03 19:38:35 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.graph | [user_1767465512690] Language detected: en
2026-01-03 19:38:36 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.graph | [user_1767465512690] New car identifier from message: AB-123-CD, intent: single_car
2026-01-03 19:38:36 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.graph | [user_1767465512690] Final state: intent=single_car, city=Amsterdam, car=AB-123-CD, zone=city center
2026-01-03 19:38:36 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.graph | [user_1767465512690] resolve_car_node - intent: single_car, identifier: AB-123-CD, selected_car: None
2026-01-03 19:38:36 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.graph | [user_1767465512690] Looking for car with identifier: AB-123-CD
2026-01-03 19:38:36 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.graph | [user_1767465512690] Zone disambiguation needed - 2 candidates
2026-01-03 19:38:37 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.main | [user_1767465512690] AFTER GRAPH - car_identifier: AB-123-CD, selected_car: AB-123-CD
2026-01-03 19:38:37 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.state | [user_1767465512690] STATE SAVE - car_identifier: AB-123-CD, selected_car: AB-123-CD, intent: single_car, city: Amsterdam
2026-01-03 19:38:37 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.trace_store | Completed trace: 6b6803f5-4498-4b91-a04c-58a9abcc402f (success=True, steps=3)
2026-01-03 19:38:37 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.main | Graph completed - session: user_1767465512690, pending_question: True
2026-01-03 19:38:37 | 6b6803f5-4498-4b91-a04c-58a9abcc402f | INFO     | app.main | Request completed: POST /chat - Status: 200
INFO:     127.0.0.1:56045 - "POST /chat HTTP/1.1" 200 OK
2026-01-03 19:38:39 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | INFO     | app.main | Incoming request: POST /chat/answer
2026-01-03 19:38:39 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | INFO     | app.main | Disambiguation answer - session: user_1767465512690, selection: 0
2026-01-03 19:38:39 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | INFO     | app.main | [user_1767465512690] DISAMBIGUATION ANSWER - car_identifier: AB-123-CD, selected_car: AB-123-CD
2026-01-03 19:38:39 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | INFO     | app.main | Selected option: Amsterdam City Center LEZ (LEZ) for session: user_1767465512690
2026-01-03 19:38:39 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | INFO     | app.main | Continuing from: fetch_policy for session: user_1767465512690
2026-01-03 19:38:39 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | INFO     | app.graph | [user_1767465512690] fetch_policy_node - zone: ams_lez_01
2026-01-03 19:38:39 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | INFO     | app.graph | [user_1767465512690] decide_node - intent: single_car
2026-01-03 19:38:39 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | INFO     | app.graph | [user_1767465512690] explain_node - generating final response
2026-01-03 19:38:41 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | INFO     | app.state | [user_1767465512690] STATE SAVE - car_identifier: AB-123-CD, selected_car: AB-123-CD, intent: single_car, city: Amsterdam
2026-01-03 19:38:41 | cf6cbc58-9f21-424c-af06-9b6e23d2b10d | ERROR    | app.main | Error processing disambiguation answer - session: user_1767465512690, error: name 'trace_store' is not defined
Traceback (most recent call last):
  File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 286, in chat_answer
    trace_store.complete_trace(trace_id, result_state.reply, success=True)
NameError: name 'trace_store' is not defined
INFO:     127.0.0.1:56049 - "POST /chat/answer HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 189, in __call__
  |     response_sent.set()
  |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | exceptiongroup.ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/protocols/http/h11_impl.py", line 406, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    |     return await self.app(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     response_sent.set()
    |   File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py", line 135, in __exit__
    |     self.gen.throw(type, value, traceback)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 40, in trace_id_middleware
    |     response = await call_next(request)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 163, in call_next
    |     raise app_exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 93, in __call__
    |     await self.simple_response(scope, receive, send, request_headers=headers)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    |     await self.app(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 304, in chat_answer
    |     trace_store.complete_trace(trace_id, None, success=False, error=str(e))
    | NameError: name 'trace_store' is not defined
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/protocols/http/h11_impl.py", line 406, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 189, in __call__
    response_sent.set()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py", line 135, in __exit__
    self.gen.throw(type, value, traceback)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 40, in trace_id_middleware
    response = await call_next(request)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 93, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    await self.app(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 304, in chat_answer
    trace_store.complete_trace(trace_id, None, success=False, error=str(e))
NameError: name 'trace_store' is not defined
2026-01-03 19:38:44 | ed6787fc-af7f-402d-bb44-41bce7861f1a | INFO     | app.main | Incoming request: GET /trace/6b6803f5-4498-4b91-a04c-58a9abcc402f
2026-01-03 19:38:44 | ed6787fc-af7f-402d-bb44-41bce7861f1a | INFO     | app.main | Trace request - trace_id: 6b6803f5-4498-4b91-a04c-58a9abcc402f
2026-01-03 19:38:44 | ed6787fc-af7f-402d-bb44-41bce7861f1a | INFO     | app.main | Request completed: GET /trace/6b6803f5-4498-4b91-a04c-58a9abcc402f - Status: 200
INFO:     127.0.0.1:56052 - "GET /trace/6b6803f5-4498-4b91-a04c-58a9abcc402f HTTP/1.1" 200 OK
2026-01-03 20:10:04 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.main | Incoming request: POST /chat
2026-01-03 20:10:04 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.main | Chat request - session: user_1767466226092, message: Can I drive my electric car IJ-789-KL into Amsterd...
2026-01-03 20:10:04 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.trace_store | Created trace: 6a58044c-a875-4f98-ace1-991ad42d7449
2026-01-03 20:10:04 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.state | [user_1767466226092] Creating NEW SESSION
2026-01-03 20:10:04 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.main | [user_1767466226092] BEFORE GRAPH - car_identifier: None, selected_car: None
2026-01-03 20:10:04 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.main | Starting graph execution - session: user_1767466226092
2026-01-03 20:10:04 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.graph | [user_1767466226092] extract_intent_node - message: Can I drive my electric car IJ-789-KL into Amsterd...
2026-01-03 20:10:05 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.graph | [user_1767466226092] Language detected: en
2026-01-03 20:10:06 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.graph | [user_1767466226092] New car identifier from message: IJ-789-KL, intent: single_car
2026-01-03 20:10:06 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.graph | [user_1767466226092] Final state: intent=single_car, city=Amsterdam, car=IJ-789-KL, zone=city center
2026-01-03 20:10:06 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.graph | [user_1767466226092] resolve_car_node - intent: single_car, identifier: IJ-789-KL, selected_car: None
2026-01-03 20:10:06 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.graph | [user_1767466226092] Looking for car with identifier: IJ-789-KL
2026-01-03 20:10:06 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.graph | [user_1767466226092] Zone disambiguation needed - 2 candidates
2026-01-03 20:10:07 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.main | [user_1767466226092] AFTER GRAPH - car_identifier: IJ-789-KL, selected_car: IJ-789-KL
2026-01-03 20:10:07 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.state | [user_1767466226092] STATE SAVE - car_identifier: IJ-789-KL, selected_car: IJ-789-KL, intent: single_car, city: Amsterdam
2026-01-03 20:10:07 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.trace_store | Completed trace: 6a58044c-a875-4f98-ace1-991ad42d7449 (success=True, steps=3)
2026-01-03 20:10:07 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.main | Graph completed - session: user_1767466226092, pending_question: True
2026-01-03 20:10:07 | 6a58044c-a875-4f98-ace1-991ad42d7449 | INFO     | app.main | Request completed: POST /chat - Status: 200
INFO:     127.0.0.1:56351 - "POST /chat HTTP/1.1" 200 OK
2026-01-03 20:10:09 | cb25251f-fe77-4074-92c3-dbc896d8c334 | INFO     | app.main | Incoming request: POST /chat/answer
2026-01-03 20:10:09 | cb25251f-fe77-4074-92c3-dbc896d8c334 | INFO     | app.main | Disambiguation answer - session: user_1767466226092, selection: 0
2026-01-03 20:10:09 | cb25251f-fe77-4074-92c3-dbc896d8c334 | INFO     | app.main | [user_1767466226092] DISAMBIGUATION ANSWER - car_identifier: IJ-789-KL, selected_car: IJ-789-KL
2026-01-03 20:10:09 | cb25251f-fe77-4074-92c3-dbc896d8c334 | INFO     | app.main | Selected option: Amsterdam City Center LEZ (LEZ) for session: user_1767466226092
2026-01-03 20:10:09 | cb25251f-fe77-4074-92c3-dbc896d8c334 | INFO     | app.main | Continuing from: fetch_policy for session: user_1767466226092
2026-01-03 20:10:09 | cb25251f-fe77-4074-92c3-dbc896d8c334 | INFO     | app.graph | [user_1767466226092] fetch_policy_node - zone: ams_lez_01
2026-01-03 20:10:09 | cb25251f-fe77-4074-92c3-dbc896d8c334 | INFO     | app.graph | [user_1767466226092] decide_node - intent: single_car
2026-01-03 20:10:09 | cb25251f-fe77-4074-92c3-dbc896d8c334 | INFO     | app.graph | [user_1767466226092] explain_node - generating final response
2026-01-03 20:10:11 | cb25251f-fe77-4074-92c3-dbc896d8c334 | INFO     | app.state | [user_1767466226092] STATE SAVE - car_identifier: IJ-789-KL, selected_car: IJ-789-KL, intent: single_car, city: Amsterdam
2026-01-03 20:10:11 | cb25251f-fe77-4074-92c3-dbc896d8c334 | ERROR    | app.main | Error processing disambiguation answer - session: user_1767466226092, error: name 'trace_store' is not defined
Traceback (most recent call last):
  File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 286, in chat_answer
    trace_store.complete_trace(trace_id, result_state.reply, success=True)
NameError: name 'trace_store' is not defined
INFO:     127.0.0.1:56356 - "POST /chat/answer HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 189, in __call__
  |     response_sent.set()
  |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/anyio/_backends/_asyncio.py", line 783, in __aexit__
  |     raise BaseExceptionGroup(
  | exceptiongroup.ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/protocols/http/h11_impl.py", line 406, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    |     return await self.app(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     response_sent.set()
    |   File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py", line 135, in __exit__
    |     self.gen.throw(type, value, traceback)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 187, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 40, in trace_id_middleware
    |     response = await call_next(request)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 163, in call_next
    |     raise app_exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 149, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 93, in __call__
    |     await self.simple_response(scope, receive, send, request_headers=headers)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    |     await self.app(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 715, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 735, in app
    |     await route.handle(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    |     raise exc
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |   File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 304, in chat_answer
    |     trace_store.complete_trace(trace_id, None, success=False, error=str(e))
    | NameError: name 'trace_store' is not defined
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/protocols/http/h11_impl.py", line 406, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 189, in __call__
    response_sent.set()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py", line 135, in __exit__
    self.gen.throw(type, value, traceback)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 187, in __call__
    response = await self.dispatch_func(request, call_next)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 40, in trace_id_middleware
    response = await call_next(request)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 163, in call_next
    raise app_exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/base.py", line 149, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 93, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    await self.app(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 715, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 735, in app
    await route.handle(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 62, in wrapped_app
    raise exc
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/_exception_handler.py", line 51, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
  File "/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
  File "/Users/dennisgorter/Projects/agentic-orchestrator/app/main.py", line 304, in chat_answer
    trace_store.complete_trace(trace_id, None, success=False, error=str(e))
NameError: name 'trace_store' is not defined
WARNING:  StatReload detected changes in 'app/main.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [9437]
/Users/dennisgorter/Projects/agentic-orchestrator/venv/lib/python3.9/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
  warnings.warn(
INFO:     Started server process [22188]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
2026-01-03 20:11:22 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.main | Incoming request: POST /chat
2026-01-03 20:11:22 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.main | Chat request - session: user_1767467480053, message: Can I drive my electric car IJ-789-KL into Amsterd...
2026-01-03 20:11:22 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.trace_store | Created trace: c6feb201-8014-4fad-9e39-6e7cb9cf5e25
2026-01-03 20:11:22 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.state | [user_1767467480053] Creating NEW SESSION
2026-01-03 20:11:22 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.main | [user_1767467480053] BEFORE GRAPH - car_identifier: None, selected_car: None
2026-01-03 20:11:22 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.main | Starting graph execution - session: user_1767467480053
2026-01-03 20:11:22 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.graph | [user_1767467480053] extract_intent_node - message: Can I drive my electric car IJ-789-KL into Amsterd...
2026-01-03 20:11:23 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.graph | [user_1767467480053] Language detected: en
2026-01-03 20:11:25 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.graph | [user_1767467480053] New car identifier from message: IJ-789-KL, intent: single_car
2026-01-03 20:11:25 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.graph | [user_1767467480053] Final state: intent=single_car, city=Amsterdam, car=IJ-789-KL, zone=city center
2026-01-03 20:11:25 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.graph | [user_1767467480053] resolve_car_node - intent: single_car, identifier: IJ-789-KL, selected_car: None
2026-01-03 20:11:25 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.graph | [user_1767467480053] Looking for car with identifier: IJ-789-KL
2026-01-03 20:11:25 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.graph | [user_1767467480053] Zone disambiguation needed - 2 candidates
2026-01-03 20:11:26 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.main | [user_1767467480053] AFTER GRAPH - car_identifier: IJ-789-KL, selected_car: IJ-789-KL
2026-01-03 20:11:26 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.state | [user_1767467480053] STATE SAVE - car_identifier: IJ-789-KL, selected_car: IJ-789-KL, intent: single_car, city: Amsterdam
2026-01-03 20:11:26 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.trace_store | Completed trace: c6feb201-8014-4fad-9e39-6e7cb9cf5e25 (success=True, steps=3)
2026-01-03 20:11:26 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.main | Graph completed - session: user_1767467480053, pending_question: True
2026-01-03 20:11:26 | c6feb201-8014-4fad-9e39-6e7cb9cf5e25 | INFO     | app.main | Request completed: POST /chat - Status: 200
INFO:     127.0.0.1:56380 - "POST /chat HTTP/1.1" 200 OK
2026-01-03 20:11:28 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.main | Incoming request: POST /chat/answer
2026-01-03 20:11:28 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.main | Disambiguation answer - session: user_1767467480053, selection: 0
2026-01-03 20:11:28 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.trace_store | Created trace: 81300a50-ad49-4de1-afcc-cc103412ca3e
2026-01-03 20:11:28 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.main | [user_1767467480053] DISAMBIGUATION ANSWER - car_identifier: IJ-789-KL, selected_car: IJ-789-KL
2026-01-03 20:11:28 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.main | Selected option: Amsterdam City Center LEZ (LEZ) for session: user_1767467480053
2026-01-03 20:11:28 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.main | Continuing from: fetch_policy for session: user_1767467480053
2026-01-03 20:11:28 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.graph | [user_1767467480053] fetch_policy_node - zone: ams_lez_01
2026-01-03 20:11:28 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.graph | [user_1767467480053] decide_node - intent: single_car
2026-01-03 20:11:28 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.graph | [user_1767467480053] explain_node - generating final response
2026-01-03 20:11:30 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.state | [user_1767467480053] STATE SAVE - car_identifier: IJ-789-KL, selected_car: IJ-789-KL, intent: single_car, city: Amsterdam
2026-01-03 20:11:30 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.trace_store | Completed trace: 81300a50-ad49-4de1-afcc-cc103412ca3e (success=True, steps=0)
2026-01-03 20:11:30 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.main | Disambiguation resolved - session: user_1767467480053, final reply length: 268
2026-01-03 20:11:30 | 81300a50-ad49-4de1-afcc-cc103412ca3e | INFO     | app.main | Request completed: POST /chat/answer - Status: 200
INFO:     127.0.0.1:56384 - "POST /chat/answer HTTP/1.1" 200 OK
2026-01-03 20:11:34 | e29e9177-ff8f-4a76-9451-a1688f506d37 | INFO     | app.main | Incoming request: GET /trace/81300a50-ad49-4de1-afcc-cc103412ca3e
2026-01-03 20:11:34 | e29e9177-ff8f-4a76-9451-a1688f506d37 | INFO     | app.main | Trace request - trace_id: 81300a50-ad49-4de1-afcc-cc103412ca3e
2026-01-03 20:11:34 | e29e9177-ff8f-4a76-9451-a1688f506d37 | INFO     | app.main | Request completed: GET /trace/81300a50-ad49-4de1-afcc-cc103412ca3e - Status: 200
INFO:     127.0.0.1:56387 - "GET /trace/81300a50-ad49-4de1-afcc-cc103412ca3e HTTP/1.1" 200 OK
2026-01-03 20:11:56 | 50617c74-bbf2-49d8-bb93-7cb31ade609c | INFO     | app.main | Incoming request: GET /trace/c6feb201-8014-4fad-9e39-6e7cb9cf5e25
2026-01-03 20:11:56 | 50617c74-bbf2-49d8-bb93-7cb31ade609c | INFO     | app.main | Trace request - trace_id: c6feb201-8014-4fad-9e39-6e7cb9cf5e25
2026-01-03 20:11:56 | 50617c74-bbf2-49d8-bb93-7cb31ade609c | INFO     | app.main | Request completed: GET /trace/c6feb201-8014-4fad-9e39-6e7cb9cf5e25 - Status: 200
INFO:     127.0.0.1:56391 - "GET /trace/c6feb201-8014-4fad-9e39-6e7cb9cf5e25 HTTP/1.1" 200 OK
2026-01-03 20:13:26 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.main | Incoming request: POST /chat
2026-01-03 20:13:26 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.main | Chat request - session: user_1767467573107, message: Kan ik Amsterdam LEZ inrijden met mijn auto IJ-789...
2026-01-03 20:13:26 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.trace_store | Created trace: d8b5f216-4f63-44fd-b177-35ceb5e1ba0f
2026-01-03 20:13:26 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.state | [user_1767467573107] Creating NEW SESSION
2026-01-03 20:13:26 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.main | [user_1767467573107] BEFORE GRAPH - car_identifier: None, selected_car: None
2026-01-03 20:13:26 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.main | Starting graph execution - session: user_1767467573107
2026-01-03 20:13:26 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] extract_intent_node - message: Kan ik Amsterdam LEZ inrijden met mijn auto IJ-789...
2026-01-03 20:13:27 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] Language detected: nl
2026-01-03 20:13:28 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] New car identifier from message: IJ-789-KL, intent: single_car
2026-01-03 20:13:28 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] Final state: intent=single_car, city=Amsterdam, car=IJ-789-KL, zone=LEZ
2026-01-03 20:13:28 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] resolve_car_node - intent: single_car, identifier: IJ-789-KL, selected_car: None
2026-01-03 20:13:28 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] Looking for car with identifier: IJ-789-KL
2026-01-03 20:13:28 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] Zone resolved: Amsterdam City Center LEZ
2026-01-03 20:13:28 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] fetch_policy_node - zone: ams_lez_01
2026-01-03 20:13:28 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] decide_node - intent: single_car
2026-01-03 20:13:28 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.graph | [user_1767467573107] explain_node - generating final response
2026-01-03 20:13:30 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.main | [user_1767467573107] AFTER GRAPH - car_identifier: IJ-789-KL, selected_car: IJ-789-KL
2026-01-03 20:13:30 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.state | [user_1767467573107] STATE SAVE - car_identifier: IJ-789-KL, selected_car: IJ-789-KL, intent: single_car, city: Amsterdam
2026-01-03 20:13:30 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.trace_store | Completed trace: d8b5f216-4f63-44fd-b177-35ceb5e1ba0f (success=True, steps=6)
2026-01-03 20:13:30 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.main | Graph completed - session: user_1767467573107, pending_question: False
2026-01-03 20:13:30 | d8b5f216-4f63-44fd-b177-35ceb5e1ba0f | INFO     | app.main | Request completed: POST /chat - Status: 200
INFO:     127.0.0.1:56403 - "POST /chat HTTP/1.1" 200 OK
2026-01-03 20:13:37 | c7912ec1-683a-44fb-9e2d-e5befedd1b26 | INFO     | app.main | Incoming request: GET /trace/d8b5f216-4f63-44fd-b177-35ceb5e1ba0f
2026-01-03 20:13:37 | c7912ec1-683a-44fb-9e2d-e5befedd1b26 | INFO     | app.main | Trace request - trace_id: d8b5f216-4f63-44fd-b177-35ceb5e1ba0f
2026-01-03 20:13:37 | c7912ec1-683a-44fb-9e2d-e5befedd1b26 | INFO     | app.main | Request completed: GET /trace/d8b5f216-4f63-44fd-b177-35ceb5e1ba0f - Status: 200
INFO:     127.0.0.1:56408 - "GET /trace/d8b5f216-4f63-44fd-b177-35ceb5e1ba0f HTTP/1.1" 200 OK
